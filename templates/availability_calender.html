{% extends 'base.html' %}
{% block title %}Availability – {{ field.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Availability: {{ field.name }}</h3>
    <a class="btn btn-outline-primary" href="{% url 'field_list' %}">← Back to Fields</a>
  </div>

  <div class="alert alert-info">
    <strong>Legend:</strong>
    <span class="badge bg-success">Approved Booking</span>
    <span class="badge bg-warning text-dark ms-2">Pending (admins only)</span>
  </div>

  <div id="calendar"></div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    slotMinTime: '06:00:00',
    slotMaxTime: '24:00:00',
    allDaySlot: false,
    nowIndicator: true,
    height: 'auto',
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: {
      url: '{% url "availability_api" field.id %}',
      failure: () => alert('Failed to load availability.')
    },
    dateClick: function(info) {
      // Click empty slot: propose a 1-hour slot starting at clicked time
      const d = info.date; // JS Date
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');

      // default 1-hour
      const start = `${hh}:${mi}`;
      const endDate = new Date(d.getTime() + 60*60*1000);
      const eh = String(endDate.getHours()).padStart(2,'0');
      const em = String(endDate.getMinutes()).padStart(2,'0');
      const end = `${eh}:${em}`;

      const url = `{% url 'book_field' field.id %}?date=${yyyy}-${mm}-${dd}&start=${start}&end=${end}`;
      window.location.href = url;
    },
    eventClick: function(info) {
      // If you want: go to receipt (only for approved)
      // info.jsEvent.preventDefault();
    }
  });
  calendar.render();
});
</script>
{% endblock %}
