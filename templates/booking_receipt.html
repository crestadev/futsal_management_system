{% extends 'base.html' %}
{% block title %}Booking Receipt{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>üèü Futsal Booking Receipt</h3>
      <button class="btn btn-outline-primary" onclick="window.print()">üñ® Print</button>
    </div>

    {% if admin_view %}
      <p class="text-muted"><small>Admin view of receipt</small></p>
    {% endif %}

    <hr>
    <p><strong>Customer:</strong> {{ booking.user.username }}</p>
    <p><strong>Field:</strong> {{ booking.field.name }}</p>
    <p><strong>Location:</strong> {{ booking.field.location }}</p>
    <p><strong>Date:</strong> {{ booking.date }}</p>
    <p><strong>Time:</strong> {{ booking.start_time }} ‚Äì {{ booking.end_time }}</p>
    <p><strong>Amount:</strong> Rs. {{ booking.amount }}</p>

    <p><strong>Status:</strong>
      {% if booking.status == 'approved' %}
        <span class="badge bg-success">Approved</span>
      {% elif booking.status == 'pending' %}
        <span class="badge bg-warning text-dark">Pending</span>
      {% else %}
        <span class="badge bg-danger">Rejected</span>
      {% endif %}
    </p>

    <p><strong>Payment:</strong>
      {% if booking.payment_status == 'paid' %}
        <span class="badge bg-success">Paid</span>
        {% if booking.payment_date %}
          <small>(on {{ booking.payment_date|date:"M d, Y H:i" }})</small>
        {% endif %}
      {% elif booking.payment_status == 'refunded' %}
        <span class="badge bg-secondary">Refunded</span>
      {% else %}
        <span class="badge bg-danger">Unpaid</span>
      {% endif %}
    </p>

    {% if booking.payment_ref %}
      <p><strong>Transaction Ref:</strong> {{ booking.payment_ref }}</p>
    {% endif %}

    {% if qr_base64 and booking.payment_status != 'paid' %}
      <hr>
      <h5>Pay via QR Code</h5>
      <p class="text-muted mb-1">Scan this code with your payment app to complete payment.</p>
      <img src="data:image/png;base64,{{ qr_base64 }}" alt="Payment QR"
           class="img-fluid border rounded p-2" style="max-width: 200px;">
    {% endif %}
    {% if booking.payment_status != 'paid' %}
    <button id="khalti-btn" class="btn btn-purple mt-3">Pay with Khalti</button>
    {% endif %}


    <hr>
    <p class="text-center text-muted mb-0">¬© 2025 Futsal Management System</p>
  </div>
</div>
{% endblock %}


<script src="https://khalti.com/static/khalti-checkout.js"></script>
<script>
  var config = {
    // replace with your TEST KEY
    publicKey: "test_public_key_1234567890",
    productIdentity: "{{ booking.id }}",
    productName: "Futsal Booking Payment",
    productUrl: window.location.href,
    amount: {{ booking.amount|floatformat:2 }} * 100,  // paisa
    
    eventHandler: {
      onSuccess(payload) {
        // send token to backend for verification
        fetch("{% url 'khalti_callback' booking.id %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({
              token: payload.token,
              amount: payload.amount,
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Payment Successful!");
                window.location.reload();
            } else {
                alert("Payment verification failed.");
            }
        });
      },

      onError(err) {
        console.log(err);
        alert("Payment error.");
      }
    }
  };

  var checkout = new KhaltiCheckout(config);
  document.getElementById("khalti-btn").onclick = function () {
    checkout.show({amount: {{ booking.amount|floatformat:2 }} * 100});
  }
</script>
