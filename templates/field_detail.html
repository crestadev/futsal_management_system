{% extends 'base.html' %}
{% load static %}
{% load avg_filters %}

{% block title %}{{ field.name }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Field Name + Rating -->
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
    <h2 class="mb-0 fw-bold">{{ field.name }}</h2>

    {% if field.reviews.exists %}
      <div class="text-warning fs-4">
        ‚≠ê {{ field.reviews.all|average:"rating"|floatformat:1 }}/5
      </div>
    {% endif %}
  </div>

  <!-- Image Carousel -->
  <div id="fieldCarousel" class="carousel slide mb-4 shadow rounded" data-bs-ride="carousel">
    <div class="carousel-inner">

      {% if field.photo %}
      <div class="carousel-item active">
        <img src="{{ field.photo.url }}" class="d-block w-100 rounded" style="max-height:420px; object-fit:cover;">
      </div>
      {% endif %}

      {% for img in field.images.all %}
      <div class="carousel-item {% if not field.photo and forloop.first %}active{% endif %}">
        <img src="{{ img.image.url }}" class="d-block w-100 rounded" style="max-height:420px; object-fit:cover;">
      </div>
      {% endfor %}

    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#fieldCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#fieldCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon"></span>
    </button>
  </div>

  <!-- Field Info -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <h4>üèü Field Information</h4>
      <p><strong>Location:</strong> {{ field.location }}</p>
      <p><strong>Rate:</strong> Rs. {{ field.price_per_hour }} / hour</p>

      <div class="d-flex gap-2 mt-3">
        <a href="{% url 'book_field' field.id %}" class="btn btn-primary btn-lg">Book Now</a>
        <a href="{% url 'availability_calendar' field.id %}" class="btn btn-outline-secondary btn-lg">View Calendar</a>
      </div>
    </div>

    <!-- Optional Reviews Section -->
    <div class="col-md-6">
      <h4 class="mb-3">‚≠ê Reviews</h4>

      {% if field.reviews.exists %}
        {% for r in field.reviews.all %}
        <div class="border rounded p-3 mb-3">
          <strong>{{ r.user.username }}</strong>  
          <span class="text-warning">
            {% for i in "12345"|slice:r.rating %}‚òÖ{% endfor %}
          </span>

          <p class="mt-2 mb-1">{{ r.comment }}</p>
          <small class="text-muted">{{ r.created_at }}</small>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No reviews yet. Be the first to review this field.</p>
      {% endif %}

      {% if user.is_authenticated %}
      <a href="{% url 'add_review' field.id %}" class="btn btn-outline-primary w-100 mt-2">Write a Review</a>
      {% else %}
      <p><a href="{% url 'login' %}">Login</a> to write a review.</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
